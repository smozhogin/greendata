name: Conditional Deploy (API to YC + UI to VM)

on:
    push:
        branches: [main]

permissions:
    contents: read

jobs:
    deploy:
        name: Build & Deploy
        runs-on: ubuntu-latest

        env:
            REGISTRY: cr.yandex/${{ secrets.YC_REGISTRY_ID }}
            TAG: ${{ github.sha }}
            API_NAME: greendata-api

        steps:
            - name: Checkout Code
              uses: actions/checkout@v4

            - name: Detect Changes
              uses: dorny/paths-filter@v3
              id: changes
              with:
                  filters: |
                      api:
                          - "models_info/**"
                          - "Dockerfile.api"
                          - "requirements-api.txt"
                      ui:
                          - "app.py"
                          - "Dockerfile.ui"
                          - "requirements-ui.txt"
                      infra:
                          - "*.tf"
                          - ".github/workflows/**"

            - name: Upload UI files to VM
              if: steps.changes.outputs.ui == 'true'
              run: |
                  sudo apt-get update -y
                  sudo apt-get install -y rsync

                  mkdir -p ~/.ssh
                  echo "${{ secrets.VM_SSH_KEY }}" > ~/.ssh/id_ed25519
                  chmod 600 ~/.ssh/id_ed25519

                  ssh-keyscan -p ${{ secrets.VM_SSH_PORT }} -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts

                  rsync -az --delete                       --exclude ".git/"                       --exclude ".github/"                       -e "ssh -p ${{ secrets.VM_SSH_PORT }} -i ~/.ssh/id_ed25519"                       ./                       ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}:~/Projects/Greendata/

            - name: Build & Restart UI Container on VM
              if: steps.changes.outputs.ui == 'true'
              uses: appleboy/ssh-action@v1.2.0
              with:
                  host: ${{ secrets.VM_HOST }}
                  username: ${{ secrets.VM_USER }}
                  key: ${{ secrets.VM_SSH_KEY }}
                  port: ${{ secrets.VM_SSH_PORT }}
                  script: |
                      set -euo pipefail
                      cd ~/Projects/Greendata/

                      TAG="${{ github.sha }}"

                      sudo docker build -f Dockerfile.ui                           -t greendata-ui:${TAG}                           .

                      sudo docker rm -f greendata-ui || true
                      sudo docker run -d --name greendata-ui --restart unless-stopped                           -e PORT=8501                           -p 127.0.0.1:8501:8501                           greendata-ui:${TAG}

                      sudo docker image prune -f || true

            - name: Setup Yandex Cloud
              if: steps.changes.outputs.api == 'true' || steps.changes.outputs.infra == 'true'
              uses: nightstory/setup-yc@v1

            - name: Configure Yandex Cloud
              if: steps.changes.outputs.api == 'true' || steps.changes.outputs.infra == 'true'
              run: |
                  cat > sa-key.json <<'JSON'
                  ${{ secrets.YC_SA_KEY_JSON }}
                  JSON
                  python -m json.tool sa-key.json > /dev/null
                  yc config set service-account-key sa-key.json
                  yc config set folder-id ${{ secrets.YC_FOLDER_ID }}

            - name: Login to Yandex Container Registry
              if: steps.changes.outputs.api == 'true'
              uses: yc-actions/yc-cr-login@v2
              with:
                  yc-sa-json-credentials: ${{ secrets.YC_SA_KEY_JSON }}

            - name: Set-up Docker Buildx
              if: steps.changes.outputs.api == 'true'
              uses: docker/setup-buildx-action@v3

            - name: Build & Push API
              if: steps.changes.outputs.api == 'true'
              uses: docker/build-push-action@v6
              with:
                  context: .
                  file: Dockerfile.api
                  push: true
                  tags: ${{ env.REGISTRY }}/${{ env.API_NAME }}:${{ env.TAG }}

            - name: Export Yandex Cloud Key for Terraform Provider
              if: steps.changes.outputs.api == 'true' || steps.changes.outputs.infra == 'true'
              run: echo "YC_SERVICE_ACCOUNT_KEY_FILE=$PWD/sa-key.json" >> $GITHUB_ENV

            - name: Setup Terraform
              if: steps.changes.outputs.api == 'true' || steps.changes.outputs.infra == 'true'
              uses: hashicorp/setup-terraform@v3

            - name: Configure Terraform CLI
              if: steps.changes.outputs.api == 'true' || steps.changes.outputs.infra == 'true'
              run: |
                  mkdir -p ~/.terraform.d
                  cat > ~/.terraform.d/terraform.rc <<'EOF'
                  provider_installation {
                      network_mirror {
                          url = "https://terraform-mirror.yandexcloud.net/"
                          include = ["registry.terraform.io/*/*"]
                      }
                      direct {
                          exclude = ["registry.terraform.io/*/*"]
                      }
                  }
                  EOF

            - name: Init Terraform
              if: steps.changes.outputs.api == 'true' || steps.changes.outputs.infra == 'true'
              run: terraform init

            - name: Apply Terraform
              if: steps.changes.outputs.api == 'true' || steps.changes.outputs.infra == 'true'
              run: |
                  terraform apply -auto-approve                       -var="folder_id=${{ secrets.YC_FOLDER_ID }}"                       -var="service_account_id=${{ secrets.YC_SERVICE_ACCOUNT_ID }}"                       -var="api_image_url=${{ env.REGISTRY }}/${{ env.API_NAME }}:${{ env.TAG }}"

            - name: Show API URL
              if: steps.changes.outputs.api == 'true' || steps.changes.outputs.infra == 'true'
              run: terraform output -raw api_url